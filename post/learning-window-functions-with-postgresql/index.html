<html lang="en">
<head>

  
  <meta charset="utf-8">
  <title>Learning window functions with postgresql</title>
  <meta name="description" content="Learning window functions with postgresql">
  <meta name="author" content="emmanuel delgado">

  
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="//chischaschos.github.io/css/fonts.css">
  
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
  

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">

  <link rel="stylesheet" href="//chischaschos.github.io/css/custom.css">

  
  
  <link rel="stylesheet" href="//chischaschos.github.io/highlight/styles/solarized_light.css">
  
  <script src="//chischaschos.github.io/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>


<div class="header pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
    <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="desktop pure-menu pure-menu-horizontal nav-menu">
            
            <a href="//chischaschos.github.io/" class="site-title pure-menu-heading">chischaschos rocks</a>
            <ul class="pure-menu-list">
                
                <li class="pure-menu-item">
                    <a href="//chischaschos.github.io/categories/pending-research" class="pure-menu-link">Pending-Research</a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="//chischaschos.github.io/about/" class="pure-menu-link">About</a>
                </li>
            </ul>
        </div>
        <div class="mobile pure-menu nav-menu">
            <a href="/" class="pure-menu-heading" id="toggle-home">chischaschos rocks</a>
            <a href="#" id="toggle-btn">&#9776;</a>
            <ul class="pure-menu-list" id="toggle-content" style="display:none;">
                
                
                <li class="pure-menu-item">
                    <a href="//chischaschos.github.io/categories/pending-research" class="pure-menu-link">Pending-Research</a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="//chischaschos.github.io/about" class="pure-menu-link">About</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>


<div class="pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
  <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="post">

            <div class="post-title">
                <p class="footnote">
                    <time class="">2017-06-03</time>
                
                    
                    |
                    
                    
                    tags:<a href="//chischaschos.github.io/tags/sql">sql</a> <a href="//chischaschos.github.io/tags/postgresql">postgresql</a> 
                    

                    

                    
                </p>
                <h1>Learning window functions with postgresql</h1>
            </div>

            <div class="post-content">
                

<h2 id="objective">Objective</h2>

<p>Learn what <a href="https://www.postgresql.org/docs/9.1/static/tutorial-window.html">window functions</a> are and how they are used.</p>

<p>This example uses the <a href="https://github.com/chischaschos/fake-messaging-app-pg">fake messaging app playgroung</a>. What we are going to do is to get the messages from groups a user is part of, only the top 3 messages of each group sorted by creation date are returned.</p>

<p>This blog is written using commit <a href="https://github.com/chischaschos/fake-messaging-app-pg/commit/cf971929380a91730dffb9b87177f664bd87aa1a">cf971929380a91730dffb9b87177f664bd87aa1a</a> of the fake messaging app playground.</p>

<h2 id="an-example-use-case">An example use case</h2>

<p>What we are going to do is <strong>to obtain the latest 3 messages a user has from each group</strong>.  To start let&rsquo;s build the database with <code>create-myapp-db.sh</code>:</p>

<pre><code class="language-bash">➜  fake-messaging-app git:(master) ./create-myapp-db.sh
CREATE TABLE
Our base user #&lt;OpenStruct id=&quot;1&quot;, name=&quot;Conner Cummings&quot;&gt;
1, 2
2, 5
3, 10
4, 17
5, 26
6, 37
7, 50
8, 65
9, 82
10, 101
11, 122
12, 145
13, 170
14, 197
15, 226
16, 257
17, 290
18, 325
19, 362
20, 401
</code></pre>

<p>Now let&rsquo;s connect to the db:</p>

<pre><code class="language-bash">➜  fake-messaging-app git:(master) psql --dbname fake_messaging_app --username postgres
psql (9.6.2)
Type &quot;help&quot; for help.

fake_messaging_app=&gt;
</code></pre>

<p>Let&rsquo;s get all the messages for group 2 of size 5:</p>

<pre><code class="language-sql">SELECT id, created_at, row_number() OVER (
  partition BY group_id ORDER BY created_at DESC)
FROM messages
WHERE group_id = 2;
</code></pre>

<pre><code class="language-bash"> id |     created_at      | row_number
----+---------------------+------------
  7 | 2017-01-01 00:00:04 |          1
  6 | 2017-01-01 00:00:03 |          2
  5 | 2017-01-01 00:00:02 |          3
  4 | 2017-01-01 00:00:01 |          4
  3 | 2017-01-01 00:00:00 |          5
(5 rows)
</code></pre>

<pre><code class="language-sql">... row_number() OVER (PARTITION BY group_id ORDER BY created_at DESC) ...
</code></pre>

<blockquote>
<p>NOTE: Window functions are permitted only in the SELECT list and the ORDER BY clause of the query. They are forbidden elsewhere, such as in GROUP BY, HAVING and WHERE clauses.</p>
</blockquote>

<p>Now only pick 3:</p>

<pre><code class="language-sql">SELECT *
FROM (
  SELECT id, created_at, row_number() OVER (
    partition BY group_id ORDER BY created_at DESC)
  FROM messages
  WHERE group_id = 2) t1
WHERE row_number &lt;= 3;
</code></pre>

<pre><code class="language-bash"> id |     created_at      | row_number
----+---------------------+------------
  7 | 2017-01-01 00:00:04 |          1
  6 | 2017-01-01 00:00:03 |          2
  5 | 2017-01-01 00:00:02 |          3
(3 rows)
</code></pre>

<p>And now do it for all the groups from one specific user:</p>

<pre><code class="language-sql">SELECT group_id, id AS message_id, user_id, created_at, row_number
FROM (
  SELECT m.id, m.user_id, m.message, m.created_at, m.group_id, row_number() OVER (
    partition BY m.group_id ORDER by m.created_at desc)
  FROM messages m
  INNER JOIN users_groups ug USING(group_id)
  WHERE ug.member_id = 1) t1
WHERE row_number &lt;= 3;
</code></pre>

<pre><code class="language-bash">----------+------------+---------+---------------------+------------
        1 |          2 |     626 | 2017-01-01 00:00:01 |          1
        1 |          1 |       1 | 2017-01-01 00:00:00 |          2
        2 |          7 |     784 | 2017-01-01 00:00:04 |          1
        2 |          6 |     143 | 2017-01-01 00:00:03 |          2
        2 |          5 |     456 | 2017-01-01 00:00:02 |          3
        3 |         17 |      34 | 2017-01-01 00:00:09 |          1
        3 |         16 |     582 | 2017-01-01 00:00:08 |          2
        3 |         15 |     342 | 2017-01-01 00:00:07 |          3
        4 |         34 |     877 | 2017-01-01 00:00:16 |          1
        4 |         33 |     778 | 2017-01-01 00:00:15 |          2
        4 |         32 |      53 | 2017-01-01 00:00:14 |          3
        5 |         60 |     215 | 2017-01-01 00:00:25 |          1
        5 |         59 |     421 | 2017-01-01 00:00:24 |          2
        5 |         58 |     641 | 2017-01-01 00:00:23 |          3
....
....
       19 |       2489 |     284 | 2017-01-01 00:06:01 |          1
       19 |       2488 |     900 | 2017-01-01 00:06:00 |          2
       19 |       2487 |     554 | 2017-01-01 00:05:59 |          3
       20 |       2890 |     960 | 2017-01-01 00:06:40 |          1
       20 |       2889 |     789 | 2017-01-01 00:06:39 |          2
       20 |       2888 |     382 | 2017-01-01 00:06:38 |          3
(59 rows)
</code></pre>

<p>Nice!</p>

<h2 id="resources">Resources</h2>

<ul>
<li><a href="https://blog.jooq.org/2014/08/12/the-difference-between-row_number-rank-and-dense_rank/">https://blog.jooq.org/2014/08/12/the-difference-between-row_number-rank-and-dense_rank/</a></li>
</ul>

                
<div id="disqus_thread"></div>
<script>
(function() {
var d = document, s = d.createElement('script');

s.src = '//chischaschos-rocks.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


            </div>
        </div>
  </div>
    <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>

<div class="footer pure-g">
    <div class="pure-u-1-24 pure-u-md-5-24"></div>
    <div class="pure-u-11-12 pure-u-md-5-8">
        <div class="pure-menu pure-menu-horizontal footer-content">
            <ul>
                <li class="pure-menu-heading" id="foot-name">emmanuel delgado:</li>

                

                
                <li class="pure-menu-item">
                    <a href="https://github.com/chischaschos" class="pure-menu-link">GitHub</a>
                </li>
                

                
                <li class="pure-menu-item">
                    <a href="https://www.linkedin.com/in/emmanueldelgado" class="pure-menu-link">LinkedIn</a>
                </li>
                

                

                
                <li class="pure-menu-item">
                    <a href="https://twitter.com/chischaschos" class="pure-menu-link">Twitter</a>
                </li>
                

            </ul>
            <a href="#" class="pure-menu-heading pull-right" id="gototop-btn">↑↑</a>
        </div>
	  </div>
      <div class="pure-u-1-24 pure-u-md-1-6"></div>
</div>


<script src="//chischaschos.github.io/js/jquery.min.js" type="text/javascript"></script>
<script src="//chischaschos.github.io/js/jquery.timeago.js" type="text/javascript"></script>
<script type="text/javascript">
  $(function(){
    $("time.timeago").timeago();
  })
  $("#toggle-btn").click(function(){
    $("#toggle-content").toggle();
    if($(this).html() === "☰") {
        $(this).html("X")
    } else {
        $(this).html("☰")
    }
  });
  $(window).resize(function(){
    if(window.innerWidth > 768) {
      $(".desktop").removeAttr("style");
    }
  });
</script>

</body>
</html>

